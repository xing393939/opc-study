### TiDB in Action: 故障排查

#### 1.SQL 调优原理
1. EXPLAIN：执行计划由一系列的算子构成。
  * id：后缀带Build总是先于Probe执行
  * estRows：估算的输出条数
  * task：有两种，root在tidb执行，cop在tikv上并发执行
  * access object：算子所访问的数据项，如table、partition、index
  * operator info：算子的其它信息
1. EXPLAIN ANALYZE：真实执行SQL，和执行计划一并返回出来，可以视为EXPLAIN语句的扩展
  * actRows：真实的输出条数
  * execution info：time:总时间, loops:此算子循环了几次
1. 算子读盘或者读TiKV：
  * TableFullScan：这是大家所熟知的 “全表扫” 操作
  * TableRangeScan：带有范围的表数据扫描操作，通常扫描的数据量不大
  * TableRowIDScan：根据上层传递下来的 RowID 精确的扫描表数据的算子
  * IndexFullScan：另一种 “全表扫”，只不过这里扫的是索引数据，不是表数据
  * IndexRangeScan：带有范围的索引数据扫描操作，通常扫描的数据量不大
1. 算子读TiDB：
  * TableReader：汇总 TiKV 上底层扫表算子是 TableFullScan 或 TableRangeScan 的算子。
  * IndexReader：汇总 TiKV 上底层扫表算子是 IndexFullScan 或 IndexRangeScan 的算子。
  * IndexLookUp：先汇总Build端TiKV扫描上来的RowID，再去Probe端上根据RowID取TiKV。Build端是IndexFullScan、IndexRangeScan，Probe端是TableRowIDScan。
  * IndexMerge：和IndexLookup类似，不过支持多个build和Probe
1. 3 种最基本的算子：
  * Selection： 代表了相应的过滤条件，select * from t where a = 5 中的 where a = 5。
  * Projection：投影操作，也用于表达式计算， select c, a + b from t 里面的 c 和 a + b就是投影和表达式计算操作。
  * Join：两个表的连接操作
  
#### 2.TiDB Dashboard
1. 流量可视化：查看热点region
1. SQL 语句分析：查看所有的sql语句的平均执行时间，平均影响行数，执行次数
1. 生成集群诊断报告
1. 日志搜索：搜索集群的系统日志

#### 3.诊断系统表
1. 集群信息表：select type, instance, status_address, uptime from information_schema.cluster_info;
1. 慢查询：select query_time, SUBSTR(query,1,50) from information_schema.slow_query
1. 当前的会话：SHOW FULL PROCESSLIST;
1. Statement Summary 系统表，对同类SQL进行汇总
  * Statement Summary Tables 是内存表
  * tidb_enable_stmt_summary：打开或关闭该功能
  * tidb_stmt_summary_refresh_interval：监控指标的刷新周期
  * tidb_stmt_summary_history_size：历史表保存的历史数量
  * max-stmt-count：保存的 SQL 的种类数量
  * max-sql-length：显示的 SQL 的最大长度
  